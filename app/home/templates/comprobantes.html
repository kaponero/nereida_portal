{% extends "accounts/base.html" %}

{% block title %} Portal {% endblock %}

{% block links %}
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/comprobantestyles.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/pop-up-img.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/spinner.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/polling.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/qr_style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='asset/css/boton_pago.css') }}">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/date-eu.js"></script>
{% endblock %}

{% block navigation %}{% endblock %}

{% block content %}
<div class="details">
    <div class="comprobantes div-table">
        <div class="cardHeader">
            <h2>Historial</h2>
        </div>

        <table id="tabla_comprobantes">
            <thead>
                <tr>
                    <th>N° de cupón</th>
                    <th>Vencimiento</th>
                    <th>Mes</th>
                    <th>Año</th>
                    <th>Fecha de pago</th>
                    <th>Monto</th>
                    <th>Recargo</th>
                    <th>Total</th>
                    <th>Método de pago</th>
                    <th>Estado</th>
                    <th>Comprobante</th>
                    <th>Medios de pago</th>
                </tr>
            </thead>

            <tbody>
            {% for line in subscriptor.vouchers %}
            {% if line.state != 'cancelled' %}
            {% set date_filter = line.first_due_date.strftime("%Y%m") | int %}
            {% if date_filter > 202304 %}
            <tr>
                <td>{{ line.voucher_number }}</td>
                <td>{{ line.first_due_date|dateformat }}</td>
                <td>{{ line.month }}</td>
                <td>{{ line.year }}</td>
                <td>{{ line.paid_date and line.paid_date.date() | dateformat or '-' }}</td>
                <td>{{ line.amount_to_pay | currencyformat(line.currency) }}</td>
                <td>{{ (line.surcharge or 0) | currencyformat(line.currency) }}</td>
                <td>{{ line.amount_to_pay_today | currencyformat(line.currency) }}</td>

                <td>
                {% if line.state == 'paid' %}
                    {{ line.pay_method_string }}
                {% else %}
                    -
                {% endif %}
                </td>

                <td>
                {% if line.state == 'paid' %}
                    <span class="estado pagado">Pagado</span>
                {% elif line.state == 'posted' %}
                    <span class="estado pendiente">Pendiente</span>
                {% else %}
                    <span class="estado otro">{{ line.state_string }}</span>
                {% endif %}
                </td>

                <td>
                {% if line.state in ['paid', 'posted'] %}
                    <a class="comprobante"
                       href="{{ url_for('base_blueprint.download_ticket', id=line.id) }}"
                       target="_blank">Descargar</a>
                {% endif %}
                </td>

                <td>
                {% if line.state not in ['paid','cancelled','draft'] and not line.siro_qr_string %}
                    <a href="#" class="generate-qr-link"
                       data-line-id="{{ line.id }}"
                       data-amount-to-pay="{{ line.amount_to_pay_today }}">
                       Generar opciones de pago
                    </a>
                    <div class="loading-container" id="loading_{{ line.id }}" style="display:none;">
                        <div class="spinner"></div>
                        <p>Generando QR...</p>
                    </div>

                {% elif line.siro_qr_string and line.state == 'posted' %}
                    <div class="qr-container">
                        <div class="thumbnail">
                            <img src="{{ url_for('siro_blueprint.show_qr', line_id=line.id, size=1) }}"
                                 onclick="openPopup('qr_siro_popup{{ line.id }}')">
                        </div>

                        <div class="regenerate-qr-container">
                            <a href="#" class="regenerate-qr-link"
                               data-line-id="{{ line.id }}"
                               data-amount-to-pay="{{ line.amount_to_pay_today }}">
                               Regenerar QR
                            </a>
                            <div class="loading-container" id="loading_regenerate_{{ line.id }}" style="display:none;">
                                <div class="spinner"></div>
                            </div>
                        </div>

                        {% if line.siro_button_url %}
                        <div class="pay_button">
                            <a class="button-71"
                               href="{{ url_for('siro_blueprint.boton_pago', voucher_id=line.id) }}">
                               Otras opciones de pago
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="popup" id="qr_siro_popup{{ line.id }}">
                        <span class="popup-close"
                              onclick="closePopup('qr_siro_popup{{ line.id }}')">&times;</span>
                        <img src="{{ url_for('siro_blueprint.show_qr', line_id=line.id, size=4) }}">
                    </div>
                {% endif %}
                </td>
            </tr>
            {% endif %}
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="polling-indicator">
    <div id="polling-status"></div>
    <span id="polling-message"></span>
    <div id="polling-count"></div>
</div>
{% endblock %}

{% block javascripts %}

<script>
const URLS = {
    verificarPago: "{{ url_for('siro_blueprint.verificar_pago') }}",
    siroSuccess: "{{ url_for('siro_blueprint.siro_success', line_id=0) }}",
    siroNoSuccess: "{{ url_for('siro_blueprint.siro_no_success', line_id=0) }}",
    generateQR: "{{ url_for('siro_blueprint.generate_qr', line_id=0) }}",
    showQR: "{{ url_for('siro_blueprint.show_qr', line_id=0) }}"
};
</script>

<script>
let intervaloVerificacion = null;

function iniciarPolling(lineId) {
    intervaloVerificacion = setInterval(() => {
        fetch(`${URLS.verificarPago}?id=${lineId}`)
        .then(r => r.json())
        .then(data => {
            if (data.estado === "APROBADO") {
                window.location.href = URLS.siroSuccess.replace('/0','/' + lineId);
            }
        });
    }, 5000);
}
</script>

<script type="text/javascript" src="{{ url_for('static', filename='asset/js/comprobantes.js') }}"></script>

<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

{% endblock %}
