{% extends "accounts/base.html" %}

{% block title %} Portal {% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block links %}
<link rel="stylesheet"
    href="{{ url_for("static", filename="asset/css/comprobantestyles.css") }}?v={{ config.APP_VERSION }}">
<link rel="stylesheet" 
    href="{{ url_for("static", filename="asset/css/pop-up-img.css") }}?v={{ config.APP_VERSION }}">
<link rel="stylesheet"
    href="{{ url_for("static", filename="asset/css/spinner.css") }}?v={{ config.APP_VERSION}}">
<link rel="stylesheet"
    href="{{ url_for("static", filename="asset/css/polling.css") }}?v={{ config.APP_VERSION }}">
<link rel="stylesheet"
    href="{{ url_for("static", filename="asset/css/qr_style.css" )}}?v={{ config.APP_VERSION }}">
<link rel="stylesheet"
    href="{{ url_for("static", filename="asset/css/boton_pago.css")}}?v={{ config.APP_VERSION }}">
<link rel="stylesheet"
    href="{{ url_for('static', filename='asset/css/mensaje_emergente.css')}}?v={{ config.APP_VERSION}}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/date-eu.js"></script>

{% endblock %}

{% block navigation %}
{% endblock %}

{% block content %}
    <!-- -------------------- Comprobante list -------------------------------->
    <div class="details">
        <div class="comprobantes div-table">
            <div class="cardHeader">
                <h2>Historial</h2>
            </div>
            <table id="tabla_comprobantes">
                <thead>
                    <tr>
                        <th>N° de cupón</th>
                        <th>Vencimiento</th>
                        <!--<td>2° vencimiento</td>-->
                        <th>Mes</th>
                        <th>Año</th>
                        <th>Fecha de pago</th>
                        <th>Monto</th>
                        <th>Recargo</th>
                        <th>Total</th>
                        <th>Método de pago</th>
                        <th>Estado</th>
                        <th>Comprobante</th>
                        <th>Medios de pago</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line in subscriptor.vouchers %}
                        {% if line.state != 'cancelled' %}
                            <!-- convierto la fecha a entero yyyymm y la comparo con abril 2023 (202304)-->
                            {% set date_filter = line.first_due_date.strftime("%Y%m")| int %}
                            {% if date_filter > 202304 %}
<!--                                <tr class="{% if loop.index0 is even %}fila-par{% else %}fila-impar{% endif %}">-->
                                <tr>
                                    <td>{{ line.voucher_number }}</td>
                                    <td>{{ line.first_due_date|dateformat}}</td>
                                    <!--<td>{{ line.second_due_date|dateformat}}</td>-->
                                    <td>{{ line.month }}</td>
                                    <td>{{ line.year }}</td>
                                    <td>{{ line.paid_date and line.paid_date.date() | dateformat or '-'}}</td>
                                    <td>{{ line.amount_to_pay | currencyformat(line.currency) }}</td>
                                    <td>{{ (line.surcharge or 0) | currencyformat(line.currency)}}</td>
                                    <td>{{ line.amount_to_pay_today | currencyformat(line.currency) }}</td>

                                    {# Método de pago (solo si está pagado) #}
                                    {% if line.state == 'paid' %}
                                        {% if line.pay_method == 'cash' %}
                                            <td><span>Efectivo</span></td>
                                        {% elif line.pay_method == 'debit' %}
                                            <td><span>Debito</span></td>
                                        {% elif line.pay_method == 'credit' %}
                                            <td><span>Crédito</span></td>
                                        {% elif line.pay_method == 'check' %}
                                            <td><span>Cheque</span></td>
                                        {% elif line.pay_method == 'auto_debit' %}
                                            <td><span>Débito Automatico</span></td>
                                        {% elif line.pay_method == 'transfer' %}
                                            <td><span>Transferencia</span></td>
                                        {% elif line.pay_method == 'multipagos' %}
                                            <td><span>Multipagos</span></td>
                                        {% else %}
                                            <td><span>SIRO</span></td>
                                        {% endif %}
                                    {% else %}
                                        <td><span> - </span></td>
                                    {% endif %}

                                    {# Estado #}
                                    {% if line.state == 'paid' %}
                                        <td><span class="estado pagado">Pagado</span></td>
                                    {% elif line.state == 'posted' %}
                                        <td><span class="estado pendiente">Pendiente</span></td>
                                    {% else %}
                                        <td><span class="estado otro">{{ line.state_string }}</span></td>
                                    {% endif %}

                                    {# Comprobante (descarga) #}
                                    {% if line.state == 'paid' or line.state == 'posted' %}
                                        <td><a class="comprobante" href="{{url_for('base_blueprint.download_ticket', id=line.id )}}" target="_blank">Descargar</a></td>
                                    {% else %}
                                        <td><a class="sincomprobante" href="#"></a></td>
                                    {% endif %}

                                    {# Medios de pago / QR logic:
                                       Caso 1: aún no tiene QR -> link "Generar opciones de pago" + loader
                                       Caso 2: tiene QR y estado posted -> thumbnail + popup + regenerar + boton pagos
                                       Caso 3: por defecto -> mostrar line.qr_siro_string
                                    #}
                                    <td>
                                        {% if line.state not in ['paid', 'cancelled', 'draft'] and line.siro_qr_string is none %}
                                            <a id="generar_qr_{{ line.id }}" href="#" class="generate-qr-link"
                                               data-line-id="{{ line.id }}" role="button"
                                               data-amount-to-pay="{{ line.amount_to_pay_today }}">
                                                Generar opciones de pago
                                            </a>
                                            <div class="loading-container" id="loading_{{ line.id }}">
                                                <div class="spinner"></div>
                                                <p>Generando QR...</p>
                                            </div>

                                        {% elif line.siro_qr_string is not none and line.state == 'posted' %}
                                            <div class="qr-container">
                                                <div class="thumbnail">
                                                    <img src="{{ url_for('siro_blueprint.show_qr', line_id=line.id, size=1) }}"
                                                        alt="QR de pago"
                                                        class="qr-thumbnail"
                                                        data-popup-id="qr_siro_popup{{ line.id }}"
                                                        title="Haga click para expandir">
                                                </div>
                                                <div class="regenerate-qr-container">
                                                    <a href="#" class="regenerate-qr-link"
                                                       data-line-id="{{ line.id }}"
                                                       data-amount-to-pay="{{ line.amount_to_pay_today }}">
                                                        Regenerar QR <ion-icon name="reload-outline"></ion-icon>
                                                    </a>
                                                    <div class="loading-container" id="loading_regenerate_{{ line.id }}">
                                                        <div class="spinner"></div>
                                                        <p>Regenerando QR...</p>
                                                    </div>
                                                </div>
                                                {% if line.siro_button_url %}
                                                    <div class="pay_button">
                                                        <a class="button-71" role="button"
                                                            href="{{ url_for('siro_blueprint.boton_pago', voucher_id=line.id) }}">
                                                            Otras opciones de pago
                                                        </a>
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <div class="popup" id="qr_siro_popup{{ line.id }}">
                                                <span class="popup-close"
                                                    data-popup-id="qr_siro_popup{{ line.id }}"
                                                    role="button"
                                                    aria-label="Cerrar">&times;</span>

                                                <img src="{{ url_for('siro_blueprint.show_qr', line_id=line.id, size=4) }}"
                                                    alt="Imagen ampliada">
                                            </div>

                                        {% else %}
                                            {{ line.qr_siro_string }}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
<!--- - - - - - - - - - - - - - - - -  - - - - - - - -  - - - - - - - -  - - - - - - - -  - - - - - - - -  - - - - - - - -  - - - - - - - -   --->
    <!-- Contenedor del indicador -->
    <div id="polling-indicator">
        <div id="polling-status"></div>
        <span id="polling-message"></span>
        <div id="polling-count"></div>
    </div>

    <!--  Confirmación para cerrar el popup del qr    -->
    <div id="customConfirmModal" class="customConfirmModal hidden">
        <div class="customConfirmBackground">
            <h3>Pago en proceso</h3>
            <p>
                ¿Estás seguro de que quieres cerrar el QR?
                Si lo haces, no se redirigirá automáticamente cuando se acepte el pago.
            </p>
            <div class="customConfirmButtonDiv">
                <button id="confirmCloseCancel" class="confirmCloseCancel">
                    Cancelar
                </button>
                <button id="confirmCloseOK" class="confirmCloseOk">
                    Cerrar igualmente
                </button>
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascripts %}

<!-- --------------------- scripts ----------------------- -->
<script type="text/javascript"
    src="{{ url_for('static',filename='asset/js/main.js') }}?v={{ config.APP_VERSION }}"></script>

<script nonce="{{ csp_nonce }}">
// Varaibles globales para el ruteo de varios endpoints
const URLS = {
    verificarPago: "{{ url_for('siro_blueprint.verificar_pago') }}",
    siroSuccess: "{{ url_for('siro_blueprint.handle_success', voucher_id=0) }}",
    siroNoSuccess: "{{ url_for('siro_blueprint.siro_no_success', voucher_id=0) }}",
    generateQR: "{{ url_for('siro_blueprint.generate_qr', voucher_id=0) }}",
    showQR: "{{ url_for('siro_blueprint.show_qr') }}",
    botonPago: "{{ url_for('siro_blueprint.boton_pago', voucher_id=0) }}"
};
</script>

<script nonce="{{ csp_nonce }}">
// Variables globales para control
let intervaloVerificacion = null;
let currentLineId = null;

// 1. Funciones básicas para popup del QR
function openPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (!popup) return;
    //popup.style.display = 'flex';
    popup.classList.add('visible');

    // Buscar la imagen del QR dentro del popup
    const qrImg = popup.querySelector('img');
    if (!qrImg) return;

    const src = qrImg.getAttribute('src');
    if (!src || !src.includes('?')) return;

    const urlParams = new URLSearchParams(src.split('?')[1]);
    const lineId = urlParams.get('line_id');

    if (lineId) {
        currentLineId = lineId;
        iniciarPolling(lineId);
    }
}

function closePopup(popupId) {
    const popup = document.getElementById(popupId);
    if (!popup) return;

    if (intervaloVerificacion) {
        const modal = document.getElementById('customConfirmModal');
        //modal.style.display = 'flex';
        modal.classList.remove('hidden');

        const cancelBtn = document.getElementById('confirmCloseCancel');
        const okBtn = document.getElementById('confirmCloseOK');

        cancelBtn.onclick = function () {
            //modal.style.display = 'none';
            modal.classList.add('hidden');
        };

        okBtn.onclick = function () {
            //modal.style.display = 'none';
            modal.classList.add('hidden');
            //popup.style.display = 'none';
            popup.classList.remove('visible');
            clearInterval(intervaloVerificacion);
            intervaloVerificacion = null;
            ocultarIndicador();
        };
    } else {
        //popup.style.display = 'flex';
        popup.classList.remove('visible');
    }
}

document.addEventListener('click', function (e) {
    const thumb = e.target.closest('.qr-thumbnail');
    if (!thumb) return;

    const popupId = thumb.dataset.popupId;
    if (!popupId) return;

    openPopup(popupId);
});

document.addEventListener('click', function (e) {
    const closeBtn = e.target.closest('.popup-close');
    if (!closeBtn) return;

    const popupId = closeBtn.dataset.popupId;
    if (popupId) {
        closePopup(popupId);
    }
});


// 2. Sistema de polling mejorado
function iniciarPolling(lineId) {
    console.log(`Iniciando polling para línea ${lineId}`);
    mostrarIndicador('Verificando estado del pago...', 'orange');

    // Limpiar intervalo previo si existe
    if (intervaloVerificacion) {
        clearInterval(intervaloVerificacion);
    }

    let intentos = 0;

    // Verificar estado cada 5 segundos
    intervaloVerificacion = setInterval(() => {
        intentos++;
        document.getElementById('polling-count').textContent = `Verificación #${intentos}`;
        fetch(`${URLS.verificarPago}?id=${lineId}&intentos=${intentos}`)
            .then(response => {
                if (!response.ok) throw new Error('Error en la red');
                return response.json();
            })
            .then(data => {
                console.log('Respuesta del servidor:', data);

                if (data.estado === "APROBADO") {
                    pagoExitoso(lineId);
                } else if (data.estado === "EN ESPERA") {
                    // Continuar esperando
                    mostrarIndicador('Verificando estado del pago...', 'orange');
                } else if (data.estado === "RECHAZADO") {
                    pagoFallido("Pago rechazado. Por favor intente nuevamente.",
                    lineId);
                } else if (data.estado === "TIMEOUT") {
                    pagoFallido("Tiempo de espera superado. Por favor intente nuevamente.", lineId);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('polling-message').textContent = 'Error de conexión, reintentando...';
            });
    }, 5000);
}

// Funciones auxiliares
function mostrarIndicador(mensaje, color) {
    const indicador = document.getElementById('polling-indicator');
    if (indicador) {
        document.getElementById('polling-status').style.background = color;
        document.getElementById('polling-message').textContent = mensaje;
        indicador.style.display = 'block';
    }
}

function ocultarIndicador() {
    const indicador = document.getElementById('polling-indicator');
    if (indicador) {
        indicador.style.display = 'none';
        document.getElementById('polling-count').textContent =  '';
    }
}

function pagoExitoso(lineId) {
    mostrarIndicador('Pago confirmado! Redirigiendo...', 'green');
    clearInterval(intervaloVerificacion);

    setTimeout(() => {
        window.location.href = URLS.siroSuccess.replace('/0', '/' + lineId);
    }, 1500);
}

function pagoFallido(mensaje, lineId) {
    mostrarIndicador(mensaje, 'red');
    clearInterval(intervaloVerificacion);

    setTimeout(() => {
        ocultarIndicador();
        alert(mensaje);
        window.location.href = URLS.siroNoSuccess.replace('/0', '/' + lineId);
    }, 1500);

}

// 3. Generación y regeneración de QR
/* Lock para evitar error de concurrencia */
const qrLocks = {};

$(document).ready(function () {

    function generateQR(linkElement, isRegeneration = false) {
        const lineId = linkElement.data('line-id');

        if (qrLocks[lineId]) {
            console.warn(`QR ${lineId} todavía en proceso, ignorando request`);
            return;
        }
        // bloqueamos la transacción a ese lineId hasta que termine
        qrLocks[lineId] = true;

        const amountToPay = linkElement.data('amount-to-pay');
        const $loading = $(isRegeneration
                ? '#loading_regenerate_' + lineId 
                : '#loading_' + lineId
        );

        linkElement.hide();
        $loading.show();

        $.ajax({
            url: URLS.generateQR.replace('/0', '/' + lineId),
            method: 'GET',
            data: {
                amount_to_pay_today: amountToPay,
                lineId: lineId
            },
            success: function () {
                $loading.hide();
                linkElement.show();

                if (isRegeneration) {
                    document.querySelector(`.thumbnail img[src*="line_id=${lineId}"]`)
                        .src = `${URLS.showQR}?line_id=${lineId}&size=1&t=${Date.now()}`;

                    document.querySelector(`#qr_siro_popup${lineId} img`)
                        .src = `${URLS.showQR}?line_id=${lineId}&size=4&t=${Date.now()}`;

                    alert('QR regenerado correctamente');
                    return;
                }

                /* >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
                   CSP FIX: construcción DOM sin innerHTML
                   >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> */
                const td = document.getElementById(`generar_qr_${lineId}`).closest('td');
                td.textContent = '';

                const container = document.createElement('div');
                container.className = 'qr-container';

                // Thumbnail
                const thumbDiv = document.createElement('div');
                thumbDiv.className = 'thumbnail';

                const thumbImg = document.createElement('img');
                thumbImg.src = `${URLS.showQR}?line_id=${lineId}&size=1`;
                thumbImg.alt = 'QR de pago';
                thumbImg.className = 'qr-thumbnail';
                thumbImg.dataset.popupId = `qr_siro_popup${lineId}`;
                thumbImg.title = 'Haga click para expandir';

                thumbDiv.appendChild(thumbImg);
                container.appendChild(thumbDiv);

                // Regenerate
                const regenDiv = document.createElement('div');
                regenDiv.className = 'regenerate-qr-container';

                const regenLink = document.createElement('a');
                regenLink.href = '#';
                regenLink.className = 'regenerate-qr-link';
                regenLink.dataset.lineId = lineId;
                regenLink.dataset.amountToPay = amountToPay;
                regenLink.textContent = 'Regenerar QR ';

                const icon = document.createElement('ion-icon');
                icon.setAttribute('name', 'reload-outline');
                regenLink.appendChild(icon);

                regenDiv.appendChild(regenLink);

                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-container';
                loadingDiv.id = `loading_regenerate_${lineId}`;
                loadingDiv.innerHTML = '<div class="spinner"></div><p>Regenerando QR...</p>';

                regenDiv.appendChild(loadingDiv);
                container.appendChild(regenDiv);

                // Botón pago
                const payDiv = document.createElement('div');
                payDiv.className = 'pay_button';

                const payLink = document.createElement('a');
                payLink.className = 'button-71';
                payLink.role = 'button';
                payLink.href = URLS.botonPago.replace('/0', '/' + lineId);
                payLink.textContent = 'Otras opciones de pago';

                payDiv.appendChild(payLink);
                container.appendChild(payDiv);

                td.appendChild(container);

                // Popup
                const popup = document.createElement('div');
                popup.className = 'popup';
                popup.id = `qr_siro_popup${lineId}`;

                const close = document.createElement('span');
                close.className = 'popup-close';
                close.dataset.popupId = popup.id;
                close.innerHTML = '&times;';

                const popupImg = document.createElement('img');
                popupImg.src = `${URLS.showQR}?line_id=${lineId}&size=4`;
                popupImg.alt = 'Imagen ampliada';

                popup.appendChild(close);
                popup.appendChild(popupImg);
                td.appendChild(popup);

                regenLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    generateQR($(this), true);
                });
            },
            error: function (_, __, error) {
                $loading.hide();
                linkElement.show();
                alert('Error al generar el QR: ' + error);
            },
            complete: function() {
                // liberar lock
                qrLocks[lineId] = false;
                $loading.hide();
                linkElement.show();
            }
        });
    }

    $('.generate-qr-link').click(function (e) {
        e.preventDefault();
        generateQR($(this), false);
    });

    $(document).on('click', '.regenerate-qr-link', function (e) {
        e.preventDefault();
        generateQR($(this), true);
    });
});
</script>

<script type="text/javascript" src="{{ url_for('static',filename='asset/js/comprobantes.js') }}?v={{ config.APP_VERSION }}"></script>


<!-- -------------------- ionicons ----------------------- -->
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

{% endblock javascripts %}
